import Parser from 'rss-parser'
import { getFeedlyFeed } from 'server/fns/getFeedlyFeed'
import { getRecentPosts } from 'server/fns/getRecentPosts'

const parser = new Parser({})

type Params = {
  xml: string
  url: string
  xmlURL: string
}

export const parseString = async ({ xml, url, xmlURL }: Params) => {
  return parser.parseString
    .bind(parser)(xml)
    .catch(async (e) => {
      console.log(`Failed to parse ${xmlURL} with rss-parser`)
      console.log(xmlURL, xml.slice(0, 100))
      console.log(e)

      const [items, { title }] = await Promise.all([
        getRecentPosts(xmlURL),
        getFeedlyFeed(url),
      ])

      return {
        title,
        items,
      }
    })
}

// Generated by https://quicktype.io

export interface R {
  result: Result[]
}

export interface Result {
  'dc:creator': string[]
  'content:encoded': ContentEncoded
  id: string
  title: ContentEncoded
  description: ContentEncoded
  published: string
  publishedRaw: string
  updated: string
  updatedRaw: string
  author: Author
  links: Link[]
  attachments: Attachment[]
}

export interface Attachment {
  url: string
  mimeType: MIMEType
  sizeInBytes: number
}

export enum MIMEType {
  ImageJPEG = 'image/jpeg',
}

export interface Author {
  name: string
}

export interface ContentEncoded {
  value: string
}

export interface Link {
  href: string
}
